# 副本挑战机制

<cite>
**本文档引用的文件**
- [LifeDungeon.java](file://Life/src/main/java/com/bot/life/dao/entity/LifeDungeon.java)
- [LifeDungeonMapper.xml](file://Life/src/main/resources/mapper/LifeDungeonMapper.xml)
- [LifeDungeonMapper.java](file://Life/src/main/java/com/bot/life/dao/mapper/LifeDungeonMapper.java)
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java)
- [TeamService.java](file://Life/src/main/java/com/bot/life/service/TeamService.java)
- [BattleServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/BattleServiceImpl.java)
- [DungeonCommonHolder.java](file://Game/src/main/java/com/bot/game/service/DungeonCommonHolder.java)
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java)
- [CreateGroupPrinter.java](file://Game/src/main/java/com/bot/game/chain/menu/dungeon/CreateGroupPrinter.java)
- [DungeonGroupDTO.java](file://Game/src/main/java/com/bot/game/dto/DungeonGroupDTO.java)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构概述](#项目结构概述)
3. [LifeDungeon实体设计](#lifedungeon实体设计)
4. [副本挑战流程架构](#副本挑战流程架构)
5. [难度分级系统](#难度分级系统)
6. [组队要求与挑战条件](#组队要求与挑战条件)
7. [奖励系统设计](#奖励系统设计)
8. [数据持久化方案](#数据持久化方案)
9. [副本挑战序列图](#副本挑战序列图)
10. [技术实现细节](#技术实现细节)
11. [总结](#总结)

## 引言

副本挑战机制是游戏系统中的核心功能之一，它为玩家提供了结构化的挑战体验。本文档深入分析了基于LifeDungeon实体的副本挑战系统，包括难度分级、组队要求、奖励配置和持久化机制等关键组件。

## 项目结构概述

副本挑战机制涉及多个模块的协同工作：

```mermaid
graph TB
subgraph "生命周期模块"
A[LifeDungeon实体]
B[LifeDungeonMapper]
C[TeamService]
end
subgraph "战斗模块"
D[BattleService]
E[WorldBossService]
end
subgraph "游戏模块"
F[DungeonCommonHolder]
G[CreateGroupPrinter]
end
A --> B
C --> A
C --> D
D --> E
F --> G
C --> F
```

**图表来源**
- [LifeDungeon.java](file://Life/src/main/java/com/bot/life/dao/entity/LifeDungeon.java#L1-L21)
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L1-L378)

## LifeDungeon实体设计

LifeDungeon实体是副本挑战机制的核心数据模型，定义了副本的基本属性和行为特征。

### 实体结构分析

```mermaid
classDiagram
class LifeDungeon {
+Long id
+String name
+String description
+Integer minLevel
+Integer maxLevel
+Integer requiredMembers
+Integer difficulty
+String rewards
+Integer isActive
+validateRequirements() boolean
+calculateRewards() RewardPool
+checkAvailability() boolean
}
class DifficultyLevel {
<<enumeration>>
SIMPLE : 1
NORMAL : 2
HARD : 3
}
class StatusIndicator {
<<enumeration>>
INACTIVE : 0
ACTIVE : 1
}
LifeDungeon --> DifficultyLevel
LifeDungeon --> StatusIndicator
```

**图表来源**
- [LifeDungeon.java](file://Life/src/main/java/com/bot/life/dao/entity/LifeDungeon.java#L11-L20)

### 字段详解

| 字段名 | 类型 | 说明 | 取值范围 |
|--------|------|------|----------|
| id | Long | 副本唯一标识符 | 自增主键 |
| name | String | 副本名称 | UTF-8编码，最大255字符 |
| description | String | 副本描述信息 | 长文本，支持富文本格式 |
| minLevel | Integer | 最低参与等级 | 1-100 |
| maxLevel | Integer | 最高参与等级 | 1-100，必须≥minLevel |
| requiredMembers | Integer | 必需成员数量 | 1-10，通常为2 |
| difficulty | Integer | 难度级别 | 1-3（简单-困难） |
| rewards | String | 奖励配置（JSON格式） | JSON字符串 |
| isActive | Integer | 副本激活状态 | 0-1 |

**章节来源**
- [LifeDungeon.java](file://Life/src/main/java/com/bot/life/dao/entity/LifeDungeon.java#L11-L20)

## 副本挑战流程架构

副本挑战遵循严格的流程控制，确保游戏平衡性和用户体验。

```mermaid
flowchart TD
A[玩家发起挑战] --> B{检查队伍状态}
B --> |非队长| C[返回错误：你不是队长]
B --> |是队长| D{队伍是否满员}
D --> |未满员| E[返回错误：队伍未满员]
D --> |已满员| F{副本是否存在}
F --> |不存在| G[返回错误：副本不存在]
F --> |存在| H{副本是否激活}
H --> |未激活| I[返回错误：副本暂未开放]
H --> |已激活| J{检查玩家等级}
J --> |不满足| K[返回错误：等级不足]
J --> |满足| L[更新队伍状态为副本中]
L --> M[开始副本战斗]
M --> N{战斗结果}
N --> |胜利| O[计算奖励]
N --> |失败| P[处理失败结果]
O --> Q[发放奖励]
P --> R[重置队伍状态]
Q --> S[完成挑战]
R --> S
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L319-L349)

## 难度分级系统

难度分级是副本挑战机制的重要组成部分，影响副本的挑战难度和奖励价值。

### 难度级别定义

| 难度级别 | 数值 | 特征描述 | 适用玩家等级 |
|----------|------|----------|--------------|
| 简单 | 1 | 基础怪物，低伤害输出 | 1-30级 |
| 普通 | 2 | 中等强度怪物，需要策略配合 | 30-60级 |
| 困难 | 3 | 高强度怪物，复杂战斗机制 | 60-100级 |

### 难度影响因素

```mermaid
graph LR
A[难度级别] --> B[怪物属性增强]
A --> C[战斗机制复杂度]
A --> D[奖励价值提升]
A --> E[挑战时间延长]
B --> F[攻击力+20%]
B --> G[生命值+30%]
B --> H[防御力+15%]
C --> I[技能组合]
C --> J[环境因素]
C --> K[特殊机制]
D --> L[灵石奖励+50%]
D --> M[经验奖励+30%]
D --> N[道具掉落率+20%]
```

**章节来源**
- [LifeDungeon.java](file://Life/src/main/java/com/bot/life/dao/entity/LifeDungeon.java#L17)

## 组队要求与挑战条件

副本挑战采用组队模式，确保玩家之间的协作和社交互动。

### 组队系统架构

```mermaid
classDiagram
class LifeTeam {
+Long id
+Long leaderId
+String teamName
+Integer maxMembers
+Integer currentMembers
+Integer teamStatus
+Date createTime
+Date updateTime
+validateTeamFormation() boolean
+updateStatus(status) void
}
class LifeTeamMember {
+Long id
+Long teamId
+Long playerId
+Date joinTime
+validateMembership() boolean
}
class TeamStatus {
<<enumeration>>
RECRUITING : 0
FULL : 1
IN_DUNGEON : 2
}
LifeTeam --> LifeTeamMember : "包含"
LifeTeam --> TeamStatus
```

### 组队状态管理

| 状态值 | 状态名称 | 含义 | 允许操作 |
|--------|----------|------|----------|
| 0 | 招募中 | 队伍正在寻找成员 | 加入队伍、退出队伍 |
| 1 | 已满员 | 队伍成员已达到上限 | 开始挑战、退出队伍 |
| 2 | 副本中 | 队伍正在副本中挑战 | 挑战进度查看 |

**章节来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L376-L377)

### 挑战前置条件检查

```mermaid
sequenceDiagram
participant Player as 玩家
participant TeamService as 组队服务
participant DungeonService as 副本服务
participant Validator as 条件验证器
Player->>TeamService : 发起挑战请求
TeamService->>Validator : 验证队伍队长身份
Validator-->>TeamService : 身份验证通过
TeamService->>Validator : 检查队伍成员状态
Validator-->>TeamService : 队伍已满员
TeamService->>DungeonService : 查询副本信息
DungeonService-->>TeamService : 返回副本详情
TeamService->>Validator : 验证副本激活状态
Validator-->>TeamService : 副本已激活
TeamService->>Validator : 检查玩家等级要求
Validator-->>TeamService : 等级符合要求
TeamService-->>Player : 准备开始挑战
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L320-L338)

## 奖励系统设计

奖励系统采用JSON结构配置奖励池，支持多种奖励类型的灵活组合。

### 奖励配置结构

```mermaid
graph TD
A[奖励配置JSON] --> B[基础奖励]
A --> C[概率权重]
A --> D[奖励类型]
B --> E[灵石奖励]
B --> F[经验奖励]
B --> G[道具奖励]
C --> H[权重1-100]
C --> I[概率计算]
D --> J[固定奖励]
D --> K[随机奖励]
D --> L[条件奖励]
```

### 奖励池配置示例

典型的奖励配置可能包含以下结构：

```json
{
  "spiritReward": 100,
  "cultivationReward": 500,
  "itemRewards": [
    {
      "itemId": "weapon_001",
      "weight": 30,
      "quantity": 1
    },
    {
      "itemId": "material_002",
      "weight": 70,
      "quantity": 2
    }
  ],
  "experienceReward": {
    "baseExp": 1000,
    "levelBonus": 0.1
  }
}
```

### 随机算法实现

```mermaid
flowchart TD
A[开始奖励计算] --> B[解析奖励配置]
B --> C[计算总权重]
C --> D[生成随机数]
D --> E{随机数落在哪个区间}
E --> |区间1| F[选择奖励1]
E --> |区间2| G[选择奖励2]
E --> |区间N| H[选择奖励N]
F --> I[应用奖励倍率]
G --> I
H --> I
I --> J[发放奖励]
J --> K[记录奖励日志]
```

**章节来源**
- [BattleServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/BattleServiceImpl.java#L188-L191)

## 数据持久化方案

副本状态管理和挑战记录通过LifeDungeonMapper实现持久化存储。

### CRUD操作映射

```mermaid
graph LR
A[LifeDungeonMapper] --> B[selectByPrimaryKey]
A --> C[selectActiveDungeons]
A --> D[selectByDifficulty]
A --> E[insert]
A --> F[updateByPrimaryKey]
A --> G[deleteByPrimaryKey]
B --> H[按ID查询副本]
C --> I[查询所有激活副本]
D --> J[按难度查询副本]
E --> K[创建新副本]
F --> L[更新副本信息]
G --> M[删除副本]
```

**图表来源**
- [LifeDungeonMapper.xml](file://Life/src/main/resources/mapper/LifeDungeonMapper.xml#L21-L69)

### 状态管理机制

| SQL操作 | 功能描述 | 使用场景 |
|---------|----------|----------|
| selectActiveDungeons | 查询所有激活的副本 | 副本列表显示 |
| selectByDifficulty | 按难度筛选副本 | 难度选择界面 |
| updateByPrimaryKey | 更新副本状态 | 激活/禁用副本 |
| insert | 创建新副本 | 管理员添加副本 |

**章节来源**
- [LifeDungeonMapper.xml](file://Life/src/main/resources/mapper/LifeDungeonMapper.xml#L28-L42)

## 副本挑战序列图

以下是完整的副本挑战流程序列图：

```mermaid
sequenceDiagram
participant Player as 玩家
participant TeamService as 组队服务
participant DungeonMapper as 副本映射器
participant BattleService as 战斗服务
participant RewardSystem as 奖励系统
participant Database as 数据库
Player->>TeamService : 发起挑战请求(队长ID, 副本ID)
TeamService->>Database : 查询队伍信息
Database-->>TeamService : 返回队伍状态
TeamService->>TeamService : 验证队长身份
TeamService->>Database : 检查队伍成员状态
Database-->>TeamService : 返回成员状态
TeamService->>DungeonMapper : 查询副本信息
DungeonMapper-->>TeamService : 返回副本详情
TeamService->>TeamService : 验证副本激活状态
TeamService->>Database : 更新队伍状态为副本中
Database-->>TeamService : 更新成功
TeamService->>BattleService : 开始副本战斗
BattleService->>BattleService : 执行战斗逻辑
BattleService-->>TeamService : 返回战斗结果
alt 战斗胜利
TeamService->>RewardSystem : 计算奖励
RewardSystem-->>TeamService : 返回奖励配置
TeamService->>RewardSystem : 发放奖励
RewardSystem-->>TeamService : 奖励发放完成
else 战斗失败
TeamService->>TeamService : 处理失败结果
end
TeamService->>Database : 重置队伍状态
Database-->>TeamService : 重置成功
TeamService-->>Player : 返回挑战结果
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L319-L349)
- [BattleServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/BattleServiceImpl.java#L184-L193)

## 技术实现细节

### 等级区间验证

副本系统实现了严格的等级区间验证机制：

```mermaid
flowchart TD
A[玩家挑战副本] --> B{检查minLevel}
B --> |玩家等级 < minLevel| C[拒绝挑战]
B --> |玩家等级 ≥ minLevel| D{检查maxLevel}
D --> |玩家等级 > maxLevel| E[拒绝挑战]
D --> |玩家等级 ≤ maxLevel| F[允许挑战]
C --> G[提示：等级不足]
E --> H[提示：等级过高]
F --> I[继续挑战流程]
```

### 组队形成机制

```mermaid
stateDiagram-v2
[*] --> 招募中
招募中 --> 已满员 : 成员达到上限
招募中 --> 招募中 : 新成员加入
已满员 --> 副本中 : 开始挑战
副本中 --> 招募中 : 挑战结束
副本中 --> 副本中 : 挑战进行中
```

**章节来源**
- [CreateGroupPrinter.java](file://Game/src/main/java/com/bot/game/chain/menu/dungeon/CreateGroupPrinter.java#L46-L48)
- [DungeonGroupDTO.java](file://Game/src/main/java/com/bot/game/dto/DungeonGroupDTO.java#L16-L25)

### 战斗结果处理

战斗系统根据战斗结果执行不同的后续处理：

| 战斗结果 | 处理方式 | 奖励计算 | 状态更新 |
|----------|----------|----------|----------|
| 胜利 | 计算奖励，发放物品 | 基于难度和表现 | 队伍状态重置 |
| 失败 | 清理战斗记录 | 无奖励 | 队伍状态重置 |
| 逃跑 | 强制结束战斗 | 部分奖励 | 队伍状态重置 |

**章节来源**
- [DungeonCommonHolder.java](file://Game/src/main/java/com/bot/game/service/DungeonCommonHolder.java#L198-L206)

## 总结

副本挑战机制是一个复杂而精密的游戏系统，它通过以下关键组件实现了完整的挑战体验：

1. **LifeDungeon实体**：提供了副本的基础属性和行为定义
2. **难度分级系统**：确保不同水平的玩家都能找到合适的挑战
3. **组队要求机制**：促进玩家间的社交互动和协作
4. **奖励配置系统**：支持灵活的奖励组合和随机算法
5. **持久化方案**：保证数据的一致性和可靠性
6. **状态管理系统**：维护复杂的业务状态流转

这套机制不仅为玩家提供了丰富的游戏体验，也为游戏运营提供了灵活的配置能力。通过合理的抽象和模块化设计，系统具备良好的扩展性和维护性，能够适应未来功能的扩展需求。