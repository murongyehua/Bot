# 组队与团队挑战系统数据模型文档

<cite>
**本文档引用的文件**
- [Life_Database_Init.sql](file://Life_Database_Init.sql)
- [LifeTeam.java](file://Life/Life_Database_Tables_Check.md)
- [LifeTeamMember.java](file://Life/Life_Database_Tables_Check.md)
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java)
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java)
- [LifeTeamMapper.xml](file://Life/src/main/resources/mapper/LifeTeamMapper.xml)
- [LifeTeamMemberMapper.xml](file://Life/src/main/resources/mapper/LifeTeamMemberMapper.xml)
- [LifeWorldBossChallengeMapper.xml](file://Life/src/main/resources/mapper/LifeWorldBossChallengeMapper.xml)
- [浮生卷开发说明.md](file://浮生卷开发说明.md)
</cite>

## 目录
1. [系统概述](#系统概述)
2. [核心数据模型](#核心数据模型)
3. [组队系统架构](#组队系统架构)
4. [世界BOSS挑战机制](#世界boos挑战机制)
5. [数据结构详解](#数据结构详解)
6. [业务流程分析](#业务流程分析)
7. [索引设计与性能优化](#索引设计与性能优化)
8. [事务处理与状态管理](#事务处理与状态管理)
9. [系统时序图](#系统时序图)
10. [最佳实践建议](#最佳实践建议)

## 系统概述

浮生卷的组队与团队挑战系统是一个基于文字冒险游戏的多人协作机制，主要包含两个核心功能模块：

1. **组队系统**：支持玩家创建队伍、申请加入、成员管理等功能
2. **世界BOSS挑战**：允许玩家组队挑战全球性的强大BOSS，根据伤害贡献获得奖励

系统采用MySQL数据库存储，通过MyBatis框架进行数据访问，实现了完整的队伍生命周期管理和世界BOSS挑战记录功能。

## 核心数据模型

系统的核心数据模型围绕两个主要实体构建：

```mermaid
erDiagram
LIFE_TEAM {
bigint id PK
bigint leader_id FK
varchar team_name
int max_members
int current_members
int team_status
bigint dungeon_id
datetime create_time
datetime update_time
}
LIFE_TEAM_MEMBER {
bigint id PK
bigint team_id FK
bigint player_id FK
int member_status
datetime join_time
}
LIFE_WORLD_BOSS_CHALLENGE {
bigint id PK
bigint player_id FK
bigint world_boss_id FK
bigint damage_dealt
int spirit_reward
text item_rewards
datetime challenge_time
}
LIFE_PLAYER {
bigint id PK
varchar user_id UK
varchar nickname
int level
bigint spirit
bigint cultivation
bigint experience
}
LIFE_MONSTER {
bigint id PK
varchar name
bigint map_id FK
int monster_type
int attribute
int level
int health
int attack_power
int defense
}
LIFE_TEAM ||--o{ LIFE_TEAM_MEMBER : "members"
LIFE_TEAM_MEMBER ||--|| LIFE_PLAYER : "belongs_to"
LIFE_TEAM_MEMBER ||--|| LIFE_TEAM : "part_of"
LIFE_WORLD_BOSS_CHALLENGE ||--|| LIFE_PLAYER : "challenger"
LIFE_WORLD_BOSS_CHALLENGE ||--|| LIFE_MONSTER : "boss"
```

**图表来源**
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L303-L324)
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L559-L568)

**节来源**
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L303-L568)

## 组队系统架构

### 队伍状态机

组队系统实现了完整的状态管理机制，支持以下状态转换：

```mermaid
stateDiagram-v2
[*] --> 待组队 : 创建队伍
待组队 --> 已满员 : 成员达到上限
待组队 --> 副本中 : 开始挑战副本
已满员 --> 副本中 : 开始挑战副本
副本中 --> 待组队 : 副本结束
待组队 --> [*] : 解散队伍
已满员 --> [*] : 解散队伍
副本中 --> [*] : 强制解散
```

### 成员状态管理

队伍成员状态采用双层状态设计：
- **申请状态**：0-申请中，1-已同意
- **成员状态**：0-离队，1-在队

这种设计支持复杂的队伍管理场景，如待处理申请、成员离队等情况。

**节来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L37-L42)
- [LifeTeamMember.java](file://Life/Life_Database_Tables_Check.md#L16)

## 世界BOSS挑战机制

### 挑战流程

世界BOSS挑战系统实现了基于伤害贡献的奖励分配机制：

```mermaid
sequenceDiagram
participant Player as 玩家
participant Service as WorldBossService
participant Challenge as ChallengeMapper
participant Reward as RewardMapper
participant Monster as Monster
Player->>Service : 挑战世界BOSS
Service->>Service : 检查挑战条件
Service->>Monster : 创建BOSS副本
Service->>Service : 模拟战斗过程
Service->>Service : 计算总伤害
Service->>Reward : 查找奖励配置
Reward-->>Service : 返回奖励规则
Service->>Service : 计算实际奖励
Service->>Challenge : 记录挑战记录
Challenge-->>Service : 确认保存
Service-->>Player : 返回挑战结果
```

**图表来源**
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java#L77-L118)

### 奖励计算机制

系统根据玩家造成的伤害范围自动匹配奖励配置：

| 伤害范围 | 灵粹奖励 | 道具奖励 |
|---------|---------|---------|
| 0-1000 | 50 | 小修为丹×1 |
| 1001-3000 | 100 | 小修为丹×2, 回春丹×1 |
| 3001及以上 | 200 | 小修为丹×3, 回春丹×2, 大力丸×1 |

**节来源**
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java#L241-L251)

## 数据结构详解

### LIFE_TEAM 表结构

| 字段名 | 类型 | 约束 | 描述 |
|-------|------|------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | 队伍唯一标识 |
| leader_id | bigint | NOT NULL, FOREIGN KEY | 队长玩家ID |
| team_name | varchar(50) | NOT NULL | 队伍名称 |
| max_members | int | DEFAULT 2 | 最大成员数 |
| current_members | int | DEFAULT 1 | 当前成员数 |
| team_status | int | DEFAULT 0 | 队伍状态(0待组队1已满员2副本中) |
| dungeon_id | bigint | NULL | 当前副本ID |
| create_time | datetime | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### LIFE_TEAM_MEMBER 表结构

| 字段名 | 类型 | 约束 | 描述 |
|-------|------|------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | 成员记录唯一标识 |
| team_id | bigint | NOT NULL, FOREIGN KEY | 所属队伍ID |
| player_id | bigint | NOT NULL, FOREIGN KEY | 玩家ID |
| member_status | int | DEFAULT 1 | 成员状态(0申请中1已同意) |
| join_time | datetime | DEFAULT CURRENT_TIMESTAMP | 加入时间 |

### LIFE_WORLD_BOSS_CHALLENGE 表结构

| 字段名 | 类型 | 约束 | 描述 |
|-------|------|------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | 挑战记录唯一标识 |
| player_id | bigint | NOT NULL, FOREIGN KEY | 玩家ID |
| world_boss_id | bigint | NOT NULL, FOREIGN KEY | 世界BOSS ID |
| damage_dealt | bigint | NOT NULL | 造成的伤害 |
| spirit_reward | int | DEFAULT 0 | 获得的灵粹奖励 |
| item_rewards | text | NULL | 获得的道具奖励(JSON格式) |
| challenge_time | datetime | DEFAULT CURRENT_TIMESTAMP | 挑战时间 |

**节来源**
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L303-L324)
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L559-L568)

## 业务流程分析

### 组队创建流程

```mermaid
flowchart TD
Start([玩家发起创建队伍]) --> CheckPlayer{检查玩家状态}
CheckPlayer --> |已在队伍| ReturnError[返回错误：已在队伍中]
CheckPlayer --> |未在队伍| CreateTeam[创建队伍记录]
CreateTeam --> SetLeader[设置队长信息]
SetLeader --> SetStatus[设置队伍状态为待组队]
SetStatus --> AddMember[添加队长为成员]
AddMember --> SetMemberStatus[设置成员状态为已同意]
SetMemberStatus --> SaveRecords[保存所有记录]
SaveRecords --> Success[返回成功消息]
ReturnError --> End([结束])
Success --> End
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L29-L58)

### 成员加入流程

```mermaid
flowchart TD
Start([玩家申请加入]) --> CheckPlayer{检查玩家状态}
CheckPlayer --> |已在队伍| ReturnError[返回错误：已在队伍中]
CheckPlayer --> |未在队伍| CheckTeam{检查队伍状态}
CheckTeam --> |队伍不存在| ReturnNotFound[返回错误：队伍不存在]
CheckTeam --> |队伍存在| CheckFull{检查队伍是否已满}
CheckFull --> |已满| ReturnFull[返回错误：队伍已满员]
CheckFull --> |未满| CheckStatus{检查队伍状态}
CheckStatus --> |非招募状态| ReturnNotReady[返回错误：队伍不在招募状态]
CheckStatus --> |招募状态| CheckExisting{检查已有申请}
CheckExisting --> |已有申请| ReturnApplied[返回错误：已提交申请]
CheckExisting --> |无申请| CreateApplication[创建申请记录]
CreateApplication --> SetStatus[设置状态为申请中]
SetStatus --> SaveApplication[保存申请记录]
SaveApplication --> Success[返回成功消息]
ReturnError --> End([结束])
ReturnNotFound --> End
ReturnFull --> End
ReturnNotReady --> End
ReturnApplied --> End
Success --> End
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L67-L108)

### 世界BOSS挑战流程

```mermaid
flowchart TD
Start([玩家挑战BOSS]) --> ValidateConditions{验证挑战条件}
ValidateConditions --> |条件不满足| ReturnInvalid[返回错误：无法挑战]
ValidateConditions --> |条件满足| LoadBoss[加载BOSS信息]
LoadBoss --> CloneMonster[克隆BOSS副本]
CloneMonster --> SimulateBattle[模拟战斗过程]
SimulateBattle --> CalculateDamage[计算总伤害]
CalculateDamage --> FindReward[查找奖励配置]
FindReward --> CalculateReward[计算实际奖励]
CalculateReward --> RecordChallenge[记录挑战记录]
RecordChallenge --> UpdatePlayer[更新玩家数据]
UpdatePlayer --> Success[返回挑战结果]
ReturnInvalid --> End([结束])
Success --> End
```

**图表来源**
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java#L77-L118)

**节来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L29-L113)
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java#L77-L118)

## 索引设计与性能优化

### LIFE_TEAM_MEMBER 表复合索引

系统在 `life_team_member` 表上设计了两个关键索引：

1. **idx_team_id**：针对 `team_id` 字段的索引
   - 支持快速查询特定队伍的所有成员
   - 优化队伍成员管理操作

2. **idx_player_id**：针对 `player_id` 字段的索引  
   - 支持快速查询玩家所属的队伍
   - 优化玩家状态检查和队伍查询

### 索引使用场景分析

| 查询场景 | 使用的索引 | 性能特点 |
|---------|-----------|---------|
| 根据队伍ID查询成员 | idx_team_id | O(log n) 时间复杂度 |
| 根据玩家ID查询队伍 | idx_player_id | O(log n) 时间复杂度 |
| 查询待处理申请 | idx_team_id + member_status | 覆盖索引，高效查询 |
| 检查玩家是否在队伍 | idx_player_id + member_status | 快速状态验证 |

**节来源**
- [Life_Database_Init.sql](file://Life_Database_Init.sql#L322-L323)
- [LifeTeamMemberMapper.xml](file://Life/src/main/resources/mapper/LifeTeamMemberMapper.xml#L32-L64)

## 事务处理与状态管理

### 组队操作事务保证

系统在关键业务操作中实现了严格的事务控制：

```mermaid
sequenceDiagram
participant Service as 服务层
participant Transaction as 事务管理器
participant TeamMapper as 队伍Mapper
participant MemberMapper as 成员Mapper
Service->>Transaction : 开始事务
Transaction->>TeamMapper : 更新队伍状态
TeamMapper-->>Transaction : 状态更新成功
Transaction->>MemberMapper : 更新成员状态
MemberMapper-->>Transaction : 成员更新成功
alt 操作成功
Transaction->>Transaction : 提交事务
Transaction-->>Service : 返回成功
else 操作失败
Transaction->>Transaction : 回滚事务
Transaction-->>Service : 返回错误
end
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L132-L143)

### 状态一致性保障

系统通过以下机制确保数据一致性：

1. **原子性操作**：队伍状态和成员状态的更新在同一事务中完成
2. **约束检查**：数据库层面的外键约束和业务逻辑约束
3. **并发控制**：通过索引和锁机制防止并发冲突

**节来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L132-L143)

## 系统时序图

### 完整的组队挑战流程

```mermaid
sequenceDiagram
participant Player1 as 队长玩家
participant Player2 as 队员玩家
participant TeamService as 组队服务
participant WorldBossService as BOSS服务
participant Database as 数据库
Note over Player1,Player2 : 创建队伍阶段
Player1->>TeamService : 创建队伍(队伍名称)
TeamService->>Database : 插入队伍记录
TeamService->>Database : 插入队长成员记录
Database-->>TeamService : 返回队伍ID
TeamService-->>Player1 : 返回队伍信息
Note over Player1,Player2 : 成员加入阶段
Player2->>TeamService : 申请加入队伍
TeamService->>Database : 检查队伍状态
TeamService->>Database : 插入申请记录
TeamService-->>Player2 : 返回申请成功
Player1->>TeamService : 同意玩家加入
TeamService->>Database : 更新成员状态
TeamService->>Database : 更新队伍人数
TeamService-->>Player1 : 返回同意成功
Note over Player1,Player2 : 世界BOSS挑战阶段
Player1->>TeamService : 挑战世界BOSS
TeamService->>WorldBossService : 验证挑战条件
WorldBossService->>Database : 检查挑战次数
WorldBossService->>Database : 记录挑战结果
WorldBossService-->>TeamService : 返回挑战结果
TeamService-->>Player1 : 返回挑战详情
```

**图表来源**
- [TeamServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/TeamServiceImpl.java#L29-L113)
- [WorldBossServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/WorldBossServiceImpl.java#L77-L118)

## 最佳实践建议

### 数据库设计优化

1. **索引策略**
   - 在高频查询字段上建立适当索引
   - 考虑复合索引的使用场景
   - 定期分析查询计划，优化索引效果

2. **数据完整性**
   - 使用外键约束维护关系完整性
   - 实施适当的业务规则验证
   - 定期清理无效数据

3. **性能监控**
   - 监控查询执行时间
   - 分析慢查询日志
   - 根据实际使用情况调整索引策略

### 业务逻辑优化

1. **状态管理**
   - 实现完整的状态机验证
   - 提供清晰的状态转换文档
   - 添加状态变更的日志记录

2. **用户体验**
   - 提供详细的错误提示信息
   - 实现异步操作反馈
   - 优化响应时间

3. **扩展性考虑**
   - 设计可扩展的奖励系统
   - 支持动态配置BOSS属性
   - 考虑多地图支持的可能性

### 安全性建议

1. **权限控制**
   - 实现严格的权限验证
   - 防止越权操作
   - 记录敏感操作日志

2. **数据保护**
   - 实施数据备份策略
   - 保护玩家隐私信息
   - 防范SQL注入攻击

通过以上设计和优化，浮生卷的组队与团队挑战系统能够提供稳定、高效的多人协作体验，同时为未来的功能扩展奠定了良好的基础。