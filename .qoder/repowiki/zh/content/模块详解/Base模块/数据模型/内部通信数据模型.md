# 内部通信数据模型

<cite>
**本文档引用文件**  
- [CommonResp.java](file://Base/src/main/java/com/bot/base/dto/CommonResp.java)
- [ChatIdDTO.java](file://Base/src/main/java/com/bot/base/dto/ChatIdDTO.java)
- [CreatePicReq.java](file://Base/src/main/java/com/bot/base/dto/CreatePicReq.java)
- [DeepChatReq.java](file://Base/src/main/java/com/bot/base/dto/DeepChatReq.java)
- [WeChatResp.java](file://Base/src/main/java/com/bot/base/dto/WeChatResp.java)
- [WeChatRespData.java](file://Base/src/main/java/com/bot/base/dto/WeChatRespData.java)
- [OrderQueryReq.java](file://Base/src/main/java/com/bot/base/dto/OrderQueryReq.java)
- [SmsQueryReq.java](file://Base/src/main/java/com/bot/base/dto/SmsQueryReq.java)
- [GridRefundReq.java](file://Base/src/main/java/com/bot/base/dto/GridRefundReq.java)
- [DistributorServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DistributorServiceImpl.java)
- [DefaultChatServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DefaultChatServiceImpl.java)
- [TopTokenServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/TopTokenServiceImpl.java)
</cite>

## 目录
1. [统一响应体设计](#统一响应体设计)
2. [聊天会话状态管理](#聊天会话状态管理)
3. [深度聊天引擎交互](#深度聊天引擎交互)
4. [图片生成服务输入](#图片生成服务输入)
5. [微信API响应处理](#微信api响应处理)
6. [业务请求对象封装](#业务请求对象封装)
7. [跨服务数据传递](#跨服务数据传递)

## 统一响应体设计

`CommonResp` 类作为系统内部通信和外部服务交互的统一响应体，采用简洁的设计模式，包含两个核心字段：`msg` 和 `type`。`msg` 字段承载响应的具体内容，可以是文本、图片链接、文件路径等。`type` 字段则用于控制响应类型，通过预定义的数值编码实现多态响应：0 表示纯文本响应，1 表示图片响应（通常为图片URL），2 表示视频响应，3 表示文件响应。这种设计使得客户端能够根据 `type` 值准确地解析和渲染响应内容，实现了响应协议的标准化。

在 `DistributorServiceImpl` 的分发逻辑中，`CommonResp` 被广泛使用。例如，在 `doDistributeWithString` 方法中，根据业务逻辑的处理结果创建 `CommonResp` 实例，并通过 `msg` 字段传递消息内容，`type` 字段标识响应类型。当处理群聊中的“表情包”请求时，系统会从数据库中随机选取一个表情包，然后创建一个 `type` 为 `ENRespType.IMG.getType()` 的 `CommonResp`，其 `msg` 字段直接设置为表情包的URL，从而实现图片的精准推送。

**Section sources**
- [CommonResp.java](file://Base/src/main/java/com/bot/base/dto/CommonResp.java#L1-L20)
- [DistributorServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DistributorServiceImpl.java#L125-L197)

## 聊天会话状态管理

`ChatIdDTO` 类专门用于管理与深度聊天引擎（如小爱同学）交互时的会话状态。该类包含两个关键字段：`id` 和 `lastDate`。`id` 字段存储了聊天会话的唯一标识符，这是维持多轮对话连续性的核心。当用户发起新的聊天请求时，系统会检查是否存在与该用户关联的 `ChatIdDTO`。如果存在，则使用其 `id` 作为 `conversation_id` 发送给聊天引擎，从而确保新消息被正确地附加到之前的对话历史中，实现上下文感知的智能回复。

`lastDate` 字段记录了该会话最后一次活动的时间戳，主要用于会话的生命周期管理和资源清理。例如，系统可以定期扫描过期的会话（`lastDate` 距今已超过一定时间），并将其从内存中清除，以避免无限制地累积会话数据，保证系统的稳定性和性能。在 `DefaultChatServiceImpl` 中，`TOKEN_2_BASE_CHAT_ID_MAP` 静态映射将用户标识（token）与 `ChatIdDTO` 关联起来，实现了会话状态的持久化管理。

**Section sources**
- [ChatIdDTO.java](file://Base/src/main/java/com/bot/base/dto/ChatIdDTO.java#L1-L19)
- [DefaultChatServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DefaultChatServiceImpl.java#L51-L52)

## 深度聊天引擎交互

`DeepChatReq` 类定义了与深度聊天引擎进行交互时的请求参数结构。其核心字段包括：
- `inputs`：一个通用的 `Object` 类型字段，可用于传递复杂的上下文信息或附加数据，为未来的功能扩展提供了灵活性。
- `query`：字符串类型，代表用户输入的原始查询内容，是聊天引擎生成回复的主要依据。
- `response_mode`：指定响应模式，如代码中所示，可以是 `"streaming"`（流式）或 `"blocking"`（阻塞），这决定了聊天引擎是实时逐字返回结果还是等待完整回复生成后再一次性返回。
- `conversation_id`：会话ID，与 `ChatIdDTO` 中的 `id` 字段对应，用于关联多轮对话。
- `user`：用户标识，用于区分不同用户，可能用于个性化服务或日志记录。

在 `DefaultChatServiceImpl` 的 `deepChat` 方法中，系统根据不同的聊天模式（如基础聊天、语音聊天、群聊）动态构建 `DeepChatReq` 对象。它会从配置中获取相应的API密钥（`key`）、确定响应模式（`responseMode`），并从 `TOKEN_2_BASE_CHAT_ID_MAP` 等映射中检索或生成 `conversation_id`，最后将这些参数组装成 `DeepChatReq` 实例，并通过HTTP客户端发送到聊天引擎的API端点。

**Section sources**
- [DeepChatReq.java](file://Base/src/main/java/com/bot/base/dto/DeepChatReq.java#L1-L25)
- [DefaultChatServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DefaultChatServiceImpl.java#L142-L144)

## 图片生成服务输入

`CreatePicReq` 类封装了向图片生成服务发起请求所需的全部输入参数。其字段定义清晰，直接映射到生成模型的配置：
- `model`：指定使用的AI模型，例如代码中使用的 `"Kwai-Kolors/Kolors"`，允许系统支持多种风格的图片生成。
- `prompt`：用户输入的文本描述，是生成图片的核心指令，决定了图片的内容和风格。
- `image_size`：指定生成图片的尺寸，如 `"768x1024"`，满足不同场景下的分辨率需求。
- `num_inference_steps`：整数类型，控制生成过程的推理步数，影响图片质量和生成速度。

在 `DefaultChatServiceImpl` 中，当用户输入以“生图”开头的指令时，系统会提取后续的描述文本作为 `prompt`，并使用预设的 `model`、`image_size` 和 `num_inference_steps` 创建一个 `CreatePicReq` 对象。该对象随后被序列化为JSON字符串，并通过 `HttpSenderUtil.postJsonDataWithToken` 方法发送到图片生成服务的API。服务返回的响应中包含生成图片的URL，该URL最终通过 `CommonResp` 返回给用户。

**Section sources**
- [CreatePicReq.java](file://Base/src/main/java/com/bot/base/dto/CreatePicReq.java#L1-L19)
- [DefaultChatServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DefaultChatServiceImpl.java#L102-L104)

## 微信API响应处理

`WeChatResp` 和 `WeChatRespData` 类共同构成了处理微信API响应的嵌套结构设计。`WeChatResp` 作为顶层响应体，包含两个字段：
- `to_user`：字符串类型，指定消息接收方的用户标识。
- `data`：`WeChatRespData` 对象的数组，用于承载实际的消息内容。

`WeChatRespData` 类则定义了单条消息的具体内容，其字段包括：
- `at_someone`：用于@特定用户的标识。
- `cl`：可能代表消息的某种分类或级别。
- `msg`：消息的文本内容。
- `img_abspath`：图片的绝对路径，用于发送图片消息。
- `file_abspath`：文件的绝对路径，用于发送文件消息。

这种设计模式将接收方信息与消息内容解耦，`data` 数组的设计允许多条不同类型的消息（文本、图片、文件）被打包在一个响应中一次性发送，提高了通信效率。尽管在当前代码中未直接展示其构建过程，但这种结构清晰地反映了与微信API交互的数据契约。

**Section sources**
- [WeChatResp.java](file://Base/src/main/java/com/bot/base/dto/WeChatResp.java#L1-L21)
- [WeChatRespData.java](file://Base/src/main/java/com/bot/base/dto/WeChatRespData.java#L1-L23)

## 业务请求对象封装

系统为不同的业务场景定义了专用的请求对象，实现了参数的规范化封装：
- `OrderQueryReq`：用于订单查询，仅包含一个 `queryContent` 字段，用于传递订单号或查询条件。
- `SmsQueryReq`：用于查询验证码，包含 `loginName` 字段，指定要查询的登录名。
- `GridRefundReq`：用于处理退款，包含 `orderId` 字段，标识需要退款的订单。

这些DTO在 `TopTokenServiceImpl` 中被实际应用。该服务通过解析用户指令的前缀（如“退款”、“查订单”、“验证码”）来判断业务类型，并根据指令的参数数量进行基本的格式校验。校验通过后，服务会创建对应的DTO实例（如 `new GridRefundReq(reqs[1])`），将其序列化为JSON，并通过HTTP POST请求发送到后端业务系统的API。这种方式将业务逻辑与数据传输分离，使得代码结构清晰，易于维护和扩展。

**Section sources**
- [OrderQueryReq.java](file://Base/src/main/java/com/bot/base/dto/OrderQueryReq.java#L1-L15)
- [SmsQueryReq.java](file://Base/src/main/java/com/bot/base/dto/SmsQueryReq.java#L1-L15)
- [GridRefundReq.java](file://Base/src/main/java/com/bot/base/dto/GridRefundReq.java#L1-L15)
- [TopTokenServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/TopTokenServiceImpl.java#L23-L128)

## 跨服务数据传递

这些DTO在 `DistributorServiceImpl` 的分发逻辑中扮演着关键角色，实现了跨服务的数据传递和协议转换。分发器作为系统的中枢，接收来自不同渠道（如QQ、微信）的原始请求，经过一系列的预处理和状态检查后，根据请求内容将其路由到相应的业务服务。

在此过程中，原始的字符串请求被解析、转换，并封装成特定的DTO对象。例如，一个“生图”请求被转换为 `CreatePicReq` 并传递给图片生成服务；一个“退款”指令被转换为 `GridRefundReq` 并传递给工单系统。各个业务服务处理完成后，统一将结果封装成 `CommonResp` 对象返回给分发器。分发器再根据 `CommonResp` 的 `type` 字段，调用相应的消息发送工具（如 `messageSender.send` 或 `QQSender.sendGroupMessageMedia`）将响应以正确的格式（文本、图片等）发送回用户。这一系列操作通过DTO作为数据载体，实现了松耦合、高内聚的系统架构。

**Section sources**
- [DistributorServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/DistributorServiceImpl.java#L1-L414)
- [CommonResp.java](file://Base/src/main/java/com/bot/base/dto/CommonResp.java#L1-L20)
- [TopTokenServiceImpl.java](file://Base/src/main/java/com/bot/base/service/impl/TopTokenServiceImpl.java#L23-L128)