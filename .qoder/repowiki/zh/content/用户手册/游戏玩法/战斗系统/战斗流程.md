# 战斗流程

<cite>
**本文档引用文件**   
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java)
- [BattleService.java](file://Life\src\main\java\com\bot\life\service\BattleService.java)
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java)
- [BattleContext.java](file://Life\src\main\java\com\bot\life\dto\BattleContext.java)
- [BattleResult.java](file://Life\src\main\java\com\bot\life\dto\BattleResult.java)
- [ENBattleAction.java](file://Life\src\main\java\com\bot\life\enums\ENBattleAction.java)
- [Life_User_Manual.md](file://Life_User_Manual.md)
</cite>

## 目录
1. [战斗流程概述](#战斗流程概述)
2. [战斗状态管理](#战斗状态管理)
3. [战斗生命周期](#战斗生命周期)
4. [回合切换机制](#回合切换机制)
5. [行动顺序判定](#行动顺序判定)
6. [战斗结果处理](#战斗结果处理)
7. [奖励发放流程](#奖励发放流程)
8. [玩家与怪物行动交互](#玩家与怪物行动交互)
9. [战斗流程时序图](#战斗流程时序图)

## 战斗流程概述

浮生卷的战斗系统采用回合制机制，玩家通过输入指令与怪物进行对抗。战斗从玩家触发"战斗"命令开始，到战斗胜利、失败或逃跑结束。整个流程由`LifeHandlerImpl`类的`handleBattleMode`方法驱动，通过`BattleService`接口协调战斗的各个阶段。

战斗系统的核心组件包括：
- **战斗上下文**（BattleContext）：存储战斗过程中的所有状态信息
- **战斗服务**（BattleService）：提供战斗逻辑的接口
- **战斗状态实体**（LifeBattleState）：持久化存储战斗状态
- **战斗结果**（BattleResult）：封装战斗结束后的结果信息

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1138-L1205)
- [BattleService.java](file://Life\src\main\java\com\bot\life\service\BattleService.java#L12-L80)

## 战斗状态管理

战斗状态通过`LifeGameStatus`和`LifeBattleState`两个实体类进行管理。`LifeGameStatus`存储玩家的全局游戏状态，而`LifeBattleState`专门存储当前战斗的详细状态。

当玩家进入战斗时，系统会：
1. 将`LifeGameStatus`的`gameMode`设置为`BATTLE`模式
2. 创建或更新`LifeBattleState`实体，记录战斗相关数据
3. 在战斗结束后清理战斗状态

`LifeBattleState`实体包含以下关键字段：
- **playerId**：玩家ID
- **monsterId**：怪物ID
- **playerHp**：玩家当前血量
- **monsterHp**：怪物当前血量
- **currentTurn**：当前回合数
- **monsterSkillCooldowns**：怪物技能冷却状态

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1076-L1085)
- [LifeBattleState.java](file://Life\src\main\java\com\bot\life\dao\entity\LifeBattleState.java#L1-L50)

## 战斗生命周期

战斗的完整生命周期包括从触发到结束的五个阶段：战斗触发、战斗初始化、回合执行、战斗结束判定和状态清理。

### 战斗触发

玩家通过输入"战斗"命令触发战斗流程。系统首先检查玩家的体力是否足够，然后进入战斗模式：

```java
private String handleBattle(String userId, LifePlayer player) {
    // 检查体力
    if (!explorationService.hasEnoughStamina(player)) {
        return imageGenerationService.generateGameImageWithStatus("体力不足，无法战斗！", player);
    }
    
    // 进入战斗模式
    LifeGameStatus gameStatus = getOrCreateGameStatus(userId);
    gameStatus.setGameMode(ENGameMode.BATTLE.getCode());
    gameStatus.setUpdateTime(new Date());
    gameStatusMapper.updateByPrimaryKey(gameStatus);
}
```

### 战斗初始化

战斗初始化由`BattleService.startBattle`方法完成，该方法创建战斗上下文并根据速度属性决定先手权：

```java
@Override
public BattleContext startBattle(LifePlayer player, LifeMonster monster, Integer battleType) {
    BattleContext context = new BattleContext();
    context.setPlayer(player);
    context.setMonster(monster);
    context.setBattleType(battleType);
    
    // 根据速度决定出手顺序
    context.setPlayerTurn(player.getSpeed() >= monster.getSpeed());
    
    context.addLog("『战斗开始！』");
    context.addLog(String.format("『%s』 VS 『%s』", player.getNickname(), monster.getName()));
    
    return context;
}
```

### 回合执行

在战斗模式下，系统通过`handleBattleMode`方法处理玩家的每一轮行动：

```java
private String handleBattleMode(String reqContent, String userId, LifeGameStatus gameStatus) {
    String command = reqContent.trim();
    LifePlayer player = playerService.getPlayerByUserId(userId);
    
    switch (command) {
        case "攻击":
        case "1":
            result = handleAttack(player);
            break;
        case "防御":
        case "2":
            result = handleDefense(player);
            break;
        case "技能":
        case "3":
            result = handleBattleSkill(player);
            break;
        case "道具":
        case "4":
            result = handleBattleItem(player);
            break;
        case "逃跑":
        case "5":
            result = handleBattleEscape(userId, player, gameStatus);
            break;
    }
}
```

### 战斗结束判定

系统在每个行动后检查战斗是否结束，包括胜利、失败或逃跑成功的情况：

```java
if (newMonsterHp <= 0) {
    // 战斗胜利
    result.append("『胜利！』击败山贼！\n");
    result.append("经验+50 灵粹+20\n");
    result.append("输入任意内容返回主菜单");
    
    // 清理战斗状态并退出战斗模式
    finishBattle(player.getId());
} else if (player.getHealth() <= 0) {
    // 战斗失败
    result.append("『败北！』\n\n");
    result.append("你被山贼击败了！\n");
    result.append("血量归1，体力-5\n\n");
    result.append("输入任意内容返回主菜单");
    
    // 失败惩罚
    player.setHealth(1);
    player.setStamina(Math.max(0, player.getStamina() - 5));
    playerService.updatePlayer(player);
    
    // 清理战斗状态
    finishBattle(player.getId());
}
```

### 状态清理

战斗结束后，系统会清理相关状态，将玩家游戏模式恢复为正常模式：

```java
private void finishBattleAndExitMode(Long playerId, String userId) {
    // 清理战斗状态
    finishBattle(playerId);
    
    // 退出战斗模式
    LifeGameStatus gameStatus = getOrCreateGameStatus(userId);
    gameStatus.setGameMode(ENGameMode.IN_GAME.getCode());
    gameStatus.setUpdateTime(new Date());
    gameStatusMapper.updateByPrimaryKey(gameStatus);
}
```

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1138-L1205)
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java#L37-L53)

## 回合切换机制

战斗的回合切换机制通过`isPlayerTurn`标志位实现，该标志位存储在`BattleContext`中，控制当前是玩家回合还是怪物回合。

### 回合切换流程

1. **玩家行动阶段**：当`isPlayerTurn`为`true`时，系统等待玩家输入行动指令
2. **玩家行动执行**：根据玩家选择的行动（攻击、防御、技能、道具、逃跑）执行相应逻辑
3. **回合切换**：玩家行动完成后，将`isPlayerTurn`设置为`false`，进入怪物回合
4. **怪物行动**：执行怪物的攻击或技能
5. **回合递增**：怪物行动完成后，将`currentRound`加1，并将`isPlayerTurn`设置为`true`
6. **循环执行**：重复上述过程，直到战斗结束

```java
@Override
public BattleContext executePlayerAction(BattleContext battleContext, ENBattleAction action, String actionParam) {
    // 执行玩家行动...
    
    // 检查怪物是否死亡
    if (monster.getHealth() <= 0) {
        battleContext.addLog(String.format("『%s』被击败了！", monster.getName()));
        battleContext.setBattleEnded(true);
        battleContext.setPlayerWin(true);
    }
    
    battleContext.setPlayerTurn(false);
    return battleContext;
}

@Override
public BattleContext executeMonsterAction(BattleContext battleContext) {
    // 执行怪物行动...
    
    // 检查玩家是否死亡
    if (player.getHealth() <= 0) {
        battleContext.addLog(String.format("『%s』被击败了！", player.getNickname()));
        battleContext.setBattleEnded(true);
        battleContext.setPlayerWin(false);
    }
    
    battleContext.setPlayerTurn(true);
    battleContext.setCurrentRound(battleContext.getCurrentRound() + 1);
    return battleContext;
}
```

### 技能冷却机制

系统实现了技能冷却机制，确保技能不能连续使用：

```java
private void updateSkillCooldowns(Long playerId) {
    List<LifePlayerSkill> playerSkills = playerSkillMapper.selectByPlayerId(playerId);
    for (LifePlayerSkill playerSkill : playerSkills) {
        if (playerSkill.getCurrentCooldown() > 0) {
            playerSkill.setCurrentCooldown(playerSkill.getCurrentCooldown() - 1);
            playerSkillMapper.updateByPrimaryKey(playerSkill);
        }
    }
}
```

**Section sources**
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java#L55-L116)
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1542-L1549)

## 行动顺序判定

战斗的行动顺序基于玩家和怪物的速度属性进行判定，速度高的单位先行动。如果速度相同，则玩家优先行动。

### 先手权判定

在战斗初始化时，系统根据速度属性决定谁先行动：

```java
// 根据速度决定出手顺序
context.setPlayerTurn(player.getSpeed() >= monster.getSpeed());
```

### 属性克制系统

系统实现了五行属性克制关系，克制方对被克制方造成额外20%伤害：

```java
private void executeNormalAttack(BattleContext context, BattleUnit attacker, BattleUnit defender) {
    // 属性克制计算
    ENAttribute attackerAttr = ENAttribute.getByCode(attacker.getAttribute());
    ENAttribute defenderAttr = ENAttribute.getByCode(defender.getAttribute());
    
    if (attackerAttr.restrains(defenderAttr)) {
        damage = (int) (damage * 1.2); // 克制伤害增加20%
        context.addLog(String.format("『属性克制！』%s对%s造成额外伤害！", attackerAttr.getDesc(), defenderAttr.getDesc()));
    }
}
```

属性克制关系如下：
- **金克木**：金属性克制木属性
- **木克土**：木属性克制土属性
- **土克水**：土属性克制水属性
- **水克火**：水属性克制火属性
- **火克金**：火属性克制金属性

### 伤害计算公式

系统采用以下公式计算伤害：

```
基础伤害 = 攻击力 - 防御力
会心伤害 = 基础伤害 × 会心伤害倍率
最终伤害 = max(1, 基础伤害 - 有效防御)
```

其中有效防御考虑了破防属性的影响：

```java
// 防御计算
double armorBreakRate = Math.min(0.3, attacker.getArmorBreak().doubleValue() / 100.0); // 破防最高30%
double effectiveDefense = defender.getDefense() * (1.0 - armorBreakRate);
```

**Section sources**
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java#L47-L48)
- [ENAttribute.java](file://Life\src\main\java\com\bot\life\enums\ENAttribute.java#L45-L53)

## 战斗结果处理

战斗结果处理包括胜利、失败和逃跑三种情况的处理逻辑。

### 胜利处理

当玩家击败怪物时，系统给予经验值和灵粹奖励，并处理怪物掉落：

```java
if (newMonsterHp <= 0) {
    // 战斗胜利
    result.append("『胜利！』击败山贼！\n");
    result.append("经验+50 灵粹+20\n");
    
    // 给予基础奖励
    boolean leveledUp = playerService.gainExperience(player, 50);
    Long currentSpirit = player.getSpirit() != null ? player.getSpirit() : 0L;
    player.setSpirit(currentSpirit + 20);
    
    // 处理怪物掉落
    String dropResult = processMonsterDrops(player, battleState.getMonsterId());
    
    playerService.updatePlayer(player);
    
    if (!dropResult.isEmpty()) {
        result.append(dropResult);
    }
    
    if (leveledUp) {
        result.append("『恭喜！』升级了！\n");
    }
    
    result.append("输入任意内容返回主菜单");
}
```

### 失败处理

当玩家被击败时，系统施加惩罚并结束战斗：

```java
if (player.getHealth() <= 0) {
    result.append("『败北！』\n\n");
    result.append("你被山贼击败了！\n");
    result.append("血量归1，体力-5\n\n");
    result.append("输入任意内容返回主菜单");

    // 失败惩罚
    player.setHealth(1);
    player.setStamina(Math.max(0, player.getStamina() - 5));
    playerService.updatePlayer(player);
}
```

### 逃跑处理

逃跑成功率基于速度差计算，速度越高逃跑成功率越高：

```java
if (playerSpeed >= monsterSpeed) {
    // 速度大于等于怪物，必定成功
    escapeSuccess = true;
    escapeInfo = String.format("『逃跑成功！』\n\n你的速度(%d)大于敌人(%d)，成功逃离！", playerSpeed, monsterSpeed);
} else {
    // 速度低于怪物，计算概率
    int speedDiff = monsterSpeed - playerSpeed;
    int baseSuccessRate = 50; // 基础成功率50%
    int penaltyRate = (speedDiff / 10) * 2; // 每低10点速度减少2%
    int finalSuccessRate = Math.max(10, baseSuccessRate - penaltyRate); // 最低10%
    
    Random random = new Random();
    int roll = random.nextInt(100) + 1;
    escapeSuccess = roll <= finalSuccessRate;
}
```

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1225-L1281)
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1430-L1467)

## 奖励发放流程

战斗胜利后，系统按照以下流程发放奖励：

### 基础奖励

基础奖励包括经验值和灵粹，直接添加到玩家账户：

```java
// 给予基础奖励
boolean leveledUp = playerService.gainExperience(player, 50);
Long currentSpirit = player.getSpirit() != null ? player.getSpirit() : 0L;
player.setSpirit(currentSpirit + 20);
```

### 等级提升处理

如果经验值累积达到升级要求，系统会自动处理等级提升：

```java
if (leveledUp) {
    result.append("『恭喜！』升级了！\n");
}
```

### 怪物掉落处理

系统根据怪物配置的掉落表随机生成掉落物品：

```java
private String processMonsterDrops(LifePlayer player, Long monsterId) {
    // 获取怪物掉落配置
    List<LifeMonsterDrop> drops = monsterDropMapper.selectByMonsterId(monsterId);
    if (drops.isEmpty()) {
        return "";
    }
    
    StringBuilder dropResult = new StringBuilder();
    dropResult.append("\n\n『战利品』\n");
    
    for (LifeMonsterDrop drop : drops) {
        // 根据掉落概率判断是否掉落
        if (Math.random() * 100 < drop.getDropRate()) {
            // 添加道具到背包
            inventoryService.addItem(player.getId(), drop.getItemId(), drop.getQuantity());
            dropResult.append(String.format("获得『%s』x%d\n", drop.getItem().getName(), drop.getQuantity()));
        }
    }
    
    return dropResult.toString();
}
```

### 奖励类型

系统支持多种奖励类型：
- **经验值**：用于角色升级
- **灵粹**：游戏内货币，用于购买物品
- **道具**：各种功能性的物品
- **装备**：提升角色属性的装备

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1230-L1242)
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java#L179-L193)

## 玩家与怪物行动交互

根据《Life_User_Manual.md》中关于战斗行动的描述，玩家和怪物的行动交互遵循特定的规则和流程。

### 玩家行动选项

玩家在战斗中有五种行动选择：
1. **攻击**：对怪物造成物理伤害
2. **防御**：下回合受到的伤害减少50%
3. **技能**：使用已学习的技能
4. **道具**：使用背包中的战斗道具
5. **逃跑**：尝试逃离战斗

### 怪物AI行为

怪物采用简单的AI行为模式：
- **普通攻击**：基础的物理攻击
- **技能使用**：50%概率使用技能
- **技能冷却**：技能使用后进入冷却状态

```java
private String performMonsterActionWithCooldown(LifeBattleState battleState, LifePlayer player) {
    // 查找可用技能（不在冷却中的）
    List<LifeMonsterSkill> availableSkills = new ArrayList<>();
    for (LifeMonsterSkill skill : monsterSkills) {
        String skillKey = skill.getSkillId().toString();
        if (!cooldowns.containsKey(skillKey) || cooldowns.get(skillKey) <= 0) {
            availableSkills.add(skill);
        }
    }
    
    if (!availableSkills.isEmpty() && new Random().nextBoolean()) {
        // 50% 概率使用技能（如果有可用技能）
        LifeMonsterSkill selectedSkill = availableSkills.get(new Random().nextInt(availableSkills.size()));
        // 执行技能
    } else {
        // 普通攻击
    }
}
```

### 行动顺序交互

玩家和怪物的行动交互遵循严格的回合制顺序：
1. 系统根据速度属性决定先手权
2. 先手方执行行动
3. 后手方执行行动
4. 回合数加1
5. 重复步骤2-4，直到战斗结束

### 特殊行动规则

系统实现了以下特殊行动规则：
- **防御效果**：防御状态下，下回合受到的伤害减少50%
- **逃跑惩罚**：逃跑失败后，怪物立即进行攻击
- **技能冷却**：技能使用后需要等待冷却时间才能再次使用

**Section sources**
- [Life_User_Manual.md](file://Life_User_Manual.md#L1-L100)
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1150-L1203)

## 战斗流程时序图

```mermaid
sequenceDiagram
participant 玩家 as 玩家
participant LifeHandler as LifeHandlerImpl
participant BattleService as BattleService
participant 数据库 as 数据库
玩家->>LifeHandler : 输入"战斗"
LifeHandler->>LifeHandler : 检查体力是否足够
alt 体力不足
LifeHandler-->>玩家 : "体力不足，无法战斗！"
else 体力足够
LifeHandler->>LifeHandler : 设置游戏模式为BATTLE
LifeHandler->>BattleService : startBattle(玩家, 怪物, 战斗类型)
BattleService->>BattleService : 创建BattleContext
BattleService->>BattleService : 根据速度决定先手权
BattleService-->>LifeHandler : 返回BattleContext
LifeHandler->>数据库 : 保存战斗状态(LifeBattleState)
LifeHandler-->>玩家 : "第1回合 请选择行动：\n1.攻击 2.防御 3.技能 4.道具 5.逃跑"
loop 战斗回合
玩家->>LifeHandler : 选择行动(如"攻击")
LifeHandler->>LifeHandler : 执行玩家行动
LifeHandler->>数据库 : 更新玩家血量
alt 怪物血量<=0
LifeHandler->>LifeHandler : 处理胜利逻辑
LifeHandler->>LifeHandler : 发放奖励
LifeHandler->>LifeHandler : 清理战斗状态
LifeHandler-->>玩家 : "『胜利！』...\n输入任意内容返回主菜单"
break 战斗结束
else
LifeHandler->>LifeHandler : 执行怪物行动
LifeHandler->>数据库 : 更新玩家血量
alt 玩家血量<=0
LifeHandler->>LifeHandler : 处理失败逻辑
LifeHandler->>LifeHandler : 施加惩罚
LifeHandler->>LifeHandler : 清理战斗状态
LifeHandler-->>玩家 : "『败北！』...\n输入任意内容返回主菜单"
break 战斗结束
else
LifeHandler->>LifeHandler : 回合数+1
LifeHandler-->>玩家 : "第X回合 请选择行动：\n1.攻击 2.防御 3.技能 4.道具 5.逃跑"
end
end
end
end
```

**Diagram sources **
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1138-L1205)
- [BattleService.java](file://Life\src\main\java\com\bot\life\service\BattleService.java#L21-L22)
- [BattleServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\BattleServiceImpl.java#L37-L53)

**Section sources**
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L1138-L1205)
- [BattleService.java](file://Life\src\main\java\com\bot\life\service\BattleService.java#L21-L22)