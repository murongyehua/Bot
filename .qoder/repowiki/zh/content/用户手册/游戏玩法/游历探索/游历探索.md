# 游历探索

<cite>
**本文档引用的文件**
- [ExplorationService.java](file://Life/src/main/java/com/bot/life/service/ExplorationService.java)
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java)
- [LifeHandlerImpl.java](file://Life/src/main/java/com/bot/life/service/impl/LifeHandlerImpl.java)
- [HealthRecoveryService.java](file://Life/src/main/java/com/bot/life/service/impl/HealthRecoveryServiceImpl.java)
- [HealthRecoveryTask.java](file://Life/src/main/java/com/bot/life/task/HealthRecoveryTask.java)
- [LifePlayer.java](file://Life/src/main/java/com/bot/life/dao/entity/LifePlayer.java)
- [Life_User_Manual.md](file://Life_User_Manual.md)
</cite>

## 目录
1. [概述](#概述)
2. [探索机制架构](#探索机制架构)
3. [体力系统](#体力系统)
4. [探索流程](#探索流程)
5. [随机事件系统](#随机事件系统)
6. [战斗机制](#战斗机制)
7. [奖励机制](#奖励机制)
8. [性能优化](#性能优化)
9. [故障排除](#故障排除)
10. [总结](#总结)

## 概述

游历探索是浮生卷游戏中的核心功能之一，允许玩家在游戏世界中进行探索，随机遭遇各种事件。该系统通过复杂的概率算法和事件处理机制，为玩家提供丰富的游戏体验。

### 主要特性

- **体力消耗机制**：每次探索消耗1点体力
- **自动恢复机制**：每5分钟恢复1点体力
- **随机事件系统**：包括怪物遭遇、道具发现、NPC互动等
- **战斗触发**：随机遭遇怪物并触发战斗
- **奖励多样化**：经验值、道具、修为等多种奖励

## 探索机制架构

```mermaid
classDiagram
class ExplorationService {
<<interface>>
+explore(LifePlayer) String
+encounterMonster(LifePlayer) BattleContext
+hasEnoughStamina(LifePlayer) boolean
+consumeStamina(LifePlayer, int) void
}
class ExplorationServiceImpl {
-monsterMapper LifeMonsterMapper
-battleService BattleService
-playerService PlayerService
-random Random
+explore(LifePlayer) String
+encounterMonster(LifePlayer) BattleContext
+hasEnoughStamina(LifePlayer) boolean
+consumeStamina(LifePlayer, int) void
-encounterMonsterEvent(LifePlayer) String
-findItemEvent(LifePlayer) String
-meetNpcEvent(LifePlayer) String
-specialEvent(LifePlayer) String
}
class LifeHandlerImpl {
-explorationService ExplorationService
+handleExplore(String, LifePlayer) String
}
class HealthRecoveryService {
<<interface>>
+checkAndRecoverHealth(Long) void
+recoverAllPlayersHealth() void
+updateLastBattleTime(Long) void
}
class HealthRecoveryServiceImpl {
-playerMapper LifePlayerMapper
-playerService PlayerService
+checkAndRecoverHealth(Long) void
+recoverAllPlayersHealth() void
+updateLastBattleTime(Long) void
}
class HealthRecoveryTask {
-healthRecoveryService HealthRecoveryService
+recoverHealthForAllPlayers() void
}
ExplorationService <|-- ExplorationServiceImpl
HealthRecoveryService <|-- HealthRecoveryServiceImpl
HealthRecoveryTask --> HealthRecoveryService
LifeHandlerImpl --> ExplorationService
ExplorationServiceImpl --> HealthRecoveryService
```

**图表来源**
- [ExplorationService.java](file://Life/src/main/java/com/bot/life/service/ExplorationService.java#L9-L39)
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L20-L224)
- [LifeHandlerImpl.java](file://Life/src/main/java/com/bot/life/service/impl/LifeHandlerImpl.java#L473-L476)

**章节来源**
- [ExplorationService.java](file://Life/src/main/java/com/bot/life/service/ExplorationService.java#L1-L40)
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L1-L224)

## 体力系统

### 体力属性结构

```mermaid
classDiagram
class LifePlayer {
+Integer stamina
+Integer maxStamina
+Date lastStaminaTime
+recoverStamina() void
+calculateExtendedAttributes() void
}
class HealthRecoveryServiceImpl {
+checkAndRecoverHealth(Long) void
+recoverAllPlayersHealth() void
+updateLastBattleTime(Long) void
}
class HealthRecoveryTask {
+recoverHealthForAllPlayers() void
}
LifePlayer --> HealthRecoveryServiceImpl : "使用"
HealthRecoveryTask --> HealthRecoveryServiceImpl : "调用"
```

**图表来源**
- [LifePlayer.java](file://Life/src/main/java/com/bot/life/dao/entity/LifePlayer.java#L38-L40)
- [HealthRecoveryServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/HealthRecoveryServiceImpl.java#L28-L86)

### 体力消耗机制

每次进行游历探索时，玩家会消耗1点体力：

| 操作 | 体力变化 | 触发条件 |
|------|----------|----------|
| 开始探索 | -1 | 执行"游历探索"命令 |
| 自动恢复 | +1 | 每5分钟 |
| 战斗胜利 | -1 | 战斗结束后 |
| 战斗失败 | -1 | 战斗结束后 |

### 自动恢复机制

```mermaid
flowchart TD
Start([玩家开始探索]) --> CheckStamina["检查体力是否充足"]
CheckStamina --> HasStamina{"体力 ≥ 1?"}
HasStamina --> |否| ShowError["显示体力不足提示"]
HasStamina --> |是| ConsumeStamina["消耗1点体力"]
ConsumeStamina --> GenerateRandom["生成随机事件"]
GenerateRandom --> EventRoll["随机数范围：0-99"]
EventRoll --> MonsterEvent["70% 怪物遭遇"]
EventRoll --> ItemEvent["15% 发现道具"]
EventRoll --> NPCEven["10% 遇见NPC"]
EventRoll --> SpecialEvent["5% 特殊事件"]
MonsterEvent --> EncounterMonster["遭遇怪物"]
ItemEvent --> FindItem["发现道具"]
NPCEven --> MeetNPC["遇见NPC"]
SpecialEvent --> SpecialIncident["特殊奇遇"]
EncounterMonster --> End([探索结束])
FindItem --> End
MeetNPC --> End
SpecialIncident --> End
ShowError --> End
```

**图表来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L34-L60)

**章节来源**
- [LifePlayer.java](file://Life/src/main/java/com/bot/life/dao/entity/LifePlayer.java#L77-L95)
- [HealthRecoveryServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/HealthRecoveryServiceImpl.java#L28-L62)

## 探索流程

### 探索入口

玩家通过主菜单选择"游历探索"（数字2）来启动探索功能：

```mermaid
sequenceDiagram
participant Player as 玩家
participant Handler as LifeHandlerImpl
participant Explorer as ExplorationService
participant Recovery as HealthRecoveryService
participant Battle as BattleService
Player->>Handler : 发送"2"游历探索
Handler->>Explorer : explore(player)
Explorer->>Recovery : checkAndRecoverHealth(player)
Explorer->>Explorer : hasEnoughStamina(player)
Explorer->>Explorer : consumeStamina(player, 1)
Explorer->>Explorer : 生成随机事件
Explorer->>Battle : encounterMonster(player)
Battle-->>Explorer : 返回战斗上下文
Explorer-->>Handler : 返回探索结果
Handler-->>Player : 显示探索结果图片
```

**图表来源**
- [LifeHandlerImpl.java](file://Life/src/main/java/com/bot/life/service/impl/LifeHandlerImpl.java#L473-L476)
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L34-L60)

### 探索结果处理

探索系统根据随机事件概率返回不同的结果：

| 事件类型 | 概率 | 结果示例 |
|----------|------|----------|
| 怪物遭遇 | 70% | "你在游历中遇到了『野狼』！是否要与它战斗？" |
| 发现道具 | 15% | "你在游历中发现了『小修为丹』！" |
| 遇见NPC | 10% | "你在游历中遇到了『神秘商人』！" |
| 特殊事件 | 5% | "你发现了一处隐秘的修炼之地，修为+1000！" |

**章节来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L34-L60)

## 随机事件系统

### 事件分类与概率

```mermaid
graph TD
A[探索开始] --> B{随机数生成}
B --> C[0-69: 怪物遭遇 70%]
B --> D[70-84: 发现道具 15%]
B --> E[85-94: 遇见NPC 10%]
B --> F[95-99: 特殊事件 5%]
C --> G[选择地图怪物]
G --> H[创建战斗上下文]
H --> I[返回怪物信息]
D --> J[随机道具]
J --> K[返回道具发现]
E --> L[随机NPC类型]
L --> M[执行NPC交互]
M --> N[返回NPC事件]
F --> O[随机特殊事件]
O --> P[执行特殊奖励]
P --> Q[返回特殊事件]
```

**图表来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L44-L59)

### 怪物遭遇机制

当玩家遭遇怪物时，系统会：

1. **查询可用怪物**：根据玩家所在地图获取可遭遇的怪物列表
2. **随机选择怪物**：从可用怪物中随机选择一个
3. **创建战斗上下文**：为战斗准备必要的数据
4. **返回战斗信息**：告知玩家遭遇的怪物并提供战斗选项

### NPC交互系统

NPC系统提供多种交互类型：

| NPC类型 | 交互内容 | 奖励类型 |
|---------|----------|----------|
| 神秘商人 | 展示道具，出售物品 | 灵粹、道具 |
| 云游道士 | 传授修炼心得 | 修为 |
| 采药老人 | 提供治疗 | 血量恢复 |
| 剑客 | 教授战斗技巧 | 临时属性提升 |

**章节来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L91-L178)

## 战斗机制

### 战斗触发流程

```mermaid
flowchart TD
A[遭遇怪物] --> B{玩家选择}
B --> |战斗| C[启动战斗]
B --> |逃跑| D[尝试逃跑]
C --> E[计算战斗属性]
E --> F[开始战斗循环]
F --> G[玩家行动]
F --> H[怪物行动]
G --> I{战斗结束?}
H --> I
I --> |否| F
I --> |是| J[结算战斗结果]
D --> K{逃跑成功?}
K --> |是| L[战斗结束]
K --> |否| M[继续战斗]
M --> F
J --> N[获得经验]
N --> O[消耗体力]
O --> P[更新状态]
```

**图表来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L91-L106)

### 战斗奖励

战斗结束后，玩家可以获得：
- **经验值**：根据怪物等级和战斗表现获得
- **灵粹**：战斗胜利后获得的游戏货币
- **道具掉落**：部分怪物会掉落特殊道具

**章节来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L91-L106)

## 奖励机制

### 探索奖励类型

```mermaid
graph LR
A[探索奖励] --> B[经验值奖励]
A --> C[修为奖励]
A --> D[灵粹奖励]
A --> E[道具奖励]
A --> F[属性奖励]
B --> B1[基础奖励: 10经验]
B --> B2[怪物奖励: 50-200经验]
C --> C1[发现道具: 500-1000修为]
C --> C2[特殊事件: 1000-5000修为]
D --> D1[NPC交易: 10-50灵粹]
D --> D2[战斗胜利: 50-200灵粹]
E --> E1[发现道具: 小修为丹等]
E --> E2[怪物掉落: 特殊道具]
F --> F1[特殊事件: 属性+1]
F --> F2[临时buff: 攻击力提升]
```

**图表来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L108-L204)

### 特殊事件奖励

特殊事件提供高质量的奖励：

| 事件类型 | 奖励内容 | 概率 |
|----------|----------|------|
| 奇遇 | 修为+1000 | 33.3% |
| 顿悟 | 所有属性+1 | 33.3% |
| 灵泉 | 体力完全恢复 | 33.3% |

**章节来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L180-L204)

## 性能优化

### 定时任务优化

系统采用定时任务机制进行血量恢复：

```mermaid
sequenceDiagram
participant Scheduler as Spring调度器
participant Task as HealthRecoveryTask
participant Service as HealthRecoveryService
participant DB as 数据库
loop 每分钟执行
Scheduler->>Task : recoverHealthForAllPlayers()
Task->>Service : recoverAllPlayersHealth()
Service->>DB : selectAllPlayers()
DB-->>Service : 玩家列表
loop 遍历每个玩家
Service->>Service : checkAndRecoverHealth(playerId)
Service->>DB : 更新玩家状态
end
end
```

**图表来源**
- [HealthRecoveryTask.java](file://Life/src/main/java/com/bot/life/task/HealthRecoveryTask.java#L18-L30)

### 内存管理

- **随机数缓存**：使用单例Random对象避免频繁创建
- **对象池化**：怪物对象采用克隆机制避免重复创建
- **延迟加载**：按需加载数据库资源

**章节来源**
- [HealthRecoveryTask.java](file://Life/src/main/java/com/bot/life/task/HealthRecoveryTask.java#L1-L31)
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L32-L224)

## 故障排除

### 常见问题及解决方案

| 问题类型 | 症状 | 解决方案 |
|----------|------|----------|
| 体力不足 | 无法进行探索 | 等待5分钟自动恢复或战斗胜利后恢复 |
| 怪物不出现 | 遭遇怪物概率低 | 检查玩家所在地图是否有怪物配置 |
| 探索卡死 | 无响应状态 | 检查数据库连接和随机数生成器 |
| 奖励异常 | 获得意外奖励 | 检查事件概率分布和奖励计算逻辑 |

### 调试信息

系统提供详细的调试信息：
- 探索事件的概率分布
- 怪物选择的随机种子
- 奖励计算的中间结果

**章节来源**
- [ExplorationServiceImpl.java](file://Life/src/main/java/com/bot/life/service/impl/ExplorationServiceImpl.java#L37-L40)

## 总结

浮生卷的游历探索系统是一个复杂而精巧的游戏机制，通过以下关键特性为玩家提供丰富的游戏体验：

### 核心优势

1. **平衡性设计**：体力消耗与恢复机制保持游戏平衡
2. **随机性保证**：完善的概率系统确保探索的不可预测性
3. **多样性奖励**：多种奖励类型满足不同玩家需求
4. **性能优化**：定时任务和内存管理确保系统稳定运行

### 技术特点

- **模块化设计**：清晰的服务接口分离关注点
- **事件驱动**：基于事件的随机系统易于扩展
- **状态管理**：完善的玩家状态跟踪机制
- **并发安全**：定时任务的异常处理保证系统稳定性

这个探索系统不仅为玩家提供了丰富的游戏内容，也为游戏开发者提供了一个可扩展的技术框架，支持未来添加更多的探索事件和奖励类型。