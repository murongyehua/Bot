# 神秘商人刷新机制

<cite>
**本文档引用文件**  
- [MarketService.java](file://Life\src\main\java\com\bot\life\service\MarketService.java)
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java)
- [LifeShop.java](file://Life\src\main\java\com\bot\life\dao\entity\LifeShop.java)
- [Life_User_Manual.md](file://Life_User_Manual.md)
</cite>

## 目录
1. [引言](#引言)
2. [刷新周期与时间规则](#刷新周期与时间规则)
3. [刷新算法与商品轮换逻辑](#刷新算法与商品轮换逻辑)
4. [触发条件与同步机制](#触发条件与同步机制)
5. [刷新流程代码分析](#刷新流程代码分析)
6. [刷新时机对商品获取的影响](#刷新时机对商品获取的影响)
7. [最佳查看时间建议](#最佳查看时间建议)
8. [结论](#结论)

## 引言

神秘商人是《浮生卷》游戏中重要的交易系统之一，为玩家提供每日刷新的折扣商品。该系统通过“鬼市”功能入口访问，允许玩家购买各类道具、装备等资源。其核心机制在于每日刷新的折扣商品，直接影响玩家的资源获取效率和游戏进度。

根据《Life_User_Manual.md》中的“鬼市交易”章节描述，神秘商人商店提供固定商品并每日更新折扣，是玩家获取关键道具的重要途径。本文档将深入分析`MarketService.java`中的`refreshMysteriousShop`方法，详细说明商店的刷新时间规则、内部算法、触发条件及最佳实践。

**本节内容未直接分析具体代码文件，因此不添加节来源。**

## 刷新周期与时间规则

神秘商人商店的刷新周期为每日一次，采用基于自然日的刷新机制。系统通过比较商品最后刷新日期与当前日期来判断是否需要执行刷新操作。

刷新判断的核心逻辑位于`MarketServiceImpl.java`的`refreshMysteriousShop`方法中，使用`LocalDate.now()`获取当前日期，并通过`isSameDay`方法精确比较两个`Date`对象是否处于同一天。该比较不仅检查年份，还通过`Calendar.DAY_OF_YEAR`确保是同一日历日，避免了跨日边界时的误判。

刷新操作并非在固定时间点（如凌晨0点）强制执行，而是采用“按需刷新”策略。每当玩家访问神秘商人商店时，系统会自动调用`refreshMysteriousShop`方法进行检查。如果检测到商品从未刷新过，或最后刷新日期与当前日期不符，则立即执行刷新。

这种设计确保了玩家无论何时访问商店，看到的都是当天最新的商品和折扣，实现了刷新时间的“软同步”，即刷新效果在玩家首次访问当日时生效。

**节来源**
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L359-L392)

## 刷新算法与商品轮换逻辑

神秘商人商店的刷新算法主要涉及商品折扣的随机重置，而非商品种类的轮换。根据代码分析，商店内的商品列表（`LifeShop`）是固定的，刷新操作不会改变上架的商品种类。

刷新的核心是折扣（`discount`）和现价（`currentPrice`）的重新计算。算法逻辑如下：

1.  **遍历所有商品**：获取数据库中所有`LifeShop`记录。
2.  **生成随机折扣**：为每个商品生成一个60%至90%之间的随机折扣。具体实现为 `0.6 + random.nextDouble() * 0.3`，确保折扣范围在6折到9折之间。
3.  **计算现价**：使用公式 `currentPrice = basePrice * discount` 重新计算商品的当前售价。
4.  **更新数据库**：将新的折扣、现价和刷新日期（`lastRefreshDate`）写回数据库。

此算法保证了每日商品价格的波动性和随机性，增加了游戏的趣味性和策略性。玩家无法预测具体折扣，但知道价格必然在6-9折之间，从而激励玩家每日查看。

**节来源**
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L368-L376)

## 触发条件与同步机制

神秘商人商店的刷新由玩家访问行为触发，这是一种典型的“惰性刷新”（Lazy Refresh）机制。

### 触发条件
刷新的触发条件是玩家执行以下任一操作：
1.  从主菜单选择“5. 鬼市”进入鬼市。
2.  在鬼市主菜单中选择“1. 神秘商人商店”。

当玩家执行这些操作时，程序调用栈如下：
`LifeHandlerImpl.handleMarket` → `marketService.getMarketMainMenu` → `marketService.getMysteriousShop` → `marketService.refreshMysteriousShop`

关键在于`getMysteriousShop`方法的第一行就调用了`refreshMysteriousShop()`，确保了在展示商店列表前完成刷新检查。

### 同步机制
该机制实现了“首次访问同步”：
- **全局同步**：所有玩家共享同一套商品和折扣。一旦某个玩家触发了刷新，所有其他玩家后续访问时看到的都是刷新后的价格。
- **按日同步**：只要当天有至少一个玩家访问过神秘商人，那么当天所有玩家看到的折扣都将保持一致，直到次日再次刷新。

这种设计减轻了服务器的定时任务压力，同时保证了玩家体验的一致性。

**节来源**
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L67)
- [LifeHandlerImpl.java](file://Life\src\main\java\com\bot\life\service\impl\LifeHandlerImpl.java#L994)

## 刷新流程代码分析

以下流程图展示了神秘商人商店刷新的完整代码执行流程。

```mermaid
flowchart TD
A[玩家访问神秘商人商店] --> B{调用 getMysteriousShop()}
B --> C[执行 refreshMysteriousShop()]
C --> D{检查是否需要刷新?}
D --> |是| E[遍历所有 LifeShop 商品]
D --> |否| F[直接返回现有商品列表]
E --> G[生成 0.6-0.9 随机折扣]
G --> H[计算新现价 = 原价 * 折扣]
H --> I[设置最后刷新日期为今日]
I --> J[更新数据库记录]
J --> K[刷新完成]
K --> F
F --> L[构建并返回商店界面]
```

**图来源**
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L65-L96)
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L357-L377)

## 刷新时机对商品获取的影响

刷新时机的选择对玩家的资源规划有显著影响：

1.  **早期访问者**：
    *   **优势**：有更高的概率获得接近6折的超低折扣，以最低成本购买心仪商品。
    *   **风险**：若刷新后立即访问，可能错过后续玩家触发的、更优的随机折扣（尽管所有玩家看到的折扣一致，但首次刷新的折扣是固定的）。

2.  **晚期访问者**：
    *   **优势**：可以确保看到当天最终的、确定的折扣价格，避免因刷新而错失已查看的商品。
    *   **劣势**：失去了获得“首刷”超低折扣的机会，且热门商品可能已被其他玩家抢购一空。

由于刷新是按需触发且全局同步的，**第一个访问当天商店的玩家实际上决定了当天所有商品的折扣**。后续玩家只能接受这个已确定的价格。

**节来源**
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L362-L366)

## 最佳查看时间建议

基于上述机制分析，为玩家提供以下最佳查看时间建议：

1.  **追求最低价格**：在每日**清晨（如早上6-8点）** 第一时间访问神秘商人商店。此时服务器刚经历低峰期，你有很大概率成为当日首位访问者，从而“锁定”一个可能非常优惠的随机折扣。

2.  **确保商品库存**：同样建议在**上午时段**查看并购买。神秘商人商店的商品库存是有限的（由`inStock`字段控制），热门道具可能在一天内售罄。尽早购买可确保获取所需物品。

3.  **规避风险**：避免在深夜或凌晨查看。此时段可能已有其他玩家完成了刷新，你看到的折扣已成定局，且部分商品可能已缺货。

总而言之，**“早起的鸟儿有虫吃”** 是此系统的最佳策略。越早访问，越有机会以最低价格购买到商品。

**节来源**
- [LifeShop.java](file://Life\src\main\java\com\bot\life\dao\entity\LifeShop.java#L20)
- [MarketServiceImpl.java](file://Life\src\main\java\com\bot\life\service\impl\MarketServiceImpl.java#L368-L372)

## 结论

神秘商人刷新机制是一个设计精巧的“按需惰性刷新”系统。它通过在玩家访问时检查日期来触发每日刷新，为所有商品随机生成6-9折的折扣。该机制不改变商品种类，只改变价格，实现了成本控制与游戏趣味性的平衡。

关键在于，**每日首位访问商店的玩家决定了当天所有商品的折扣价格**。因此，建议玩家养成每日清晨优先查看神秘商人的习惯，以最大化获取高性价比商品的机会，并确保热门道具的库存。

**本节为总结性内容，未直接分析具体代码文件，因此不添加节来源。**