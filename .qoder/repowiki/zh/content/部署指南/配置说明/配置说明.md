# 配置说明

<cite>
**本文档引用的文件**  
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-dev.properties](file://Boot/src/main/resources/application-dev.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)
- [logback-spring.xml](file://Boot/src/main/resources/logback-spring.xml)
- [Life_Deployment_Guide.md](file://Life_Deployment_Guide.md)
- [SystemConfigHolder.java](file://Game/src/main/java/com/bot/game/service/SystemConfigHolder.java)
- [ENSystemConfig.java](file://Common/src/main/java/com/bot/common/enums/ENSystemConfig.java)
- [SystemConfig.java](file://Game/src/main/java/com/bot/game/dao/entity/SystemConfig.java)
- [SystemConfigMapper.java](file://Game/src/main/java/com/bot/game/dao/mapper/SystemConfigMapper.java)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心配置文件概述](#核心配置文件概述)
3. [数据库配置](#数据库配置)
4. [系统配置](#系统配置)
5. [外部API配置](#外部api配置)
6. [日志配置](#日志配置)
7. [环境配置差异对比](#环境配置差异对比)
8. [Druid连接池参数详解](#druid连接池参数详解)
9. [life_system_config表配置说明](#life_system_config表配置说明)
10. [配置修改最佳实践与风险提示](#配置修改最佳实践与风险提示)

## 项目结构
Bot项目采用模块化设计，主要包含Base、Boot、Common、Game和Life五个核心模块。其中Boot模块作为启动入口，包含所有环境配置文件；Common模块提供通用配置和枚举定义；Game模块管理游戏核心配置；Life模块则专注于浮生卷游戏的特殊配置。

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [Life_Deployment_Guide.md](file://Life_Deployment_Guide.md)

## 核心配置文件概述
Bot项目采用Spring Boot的多环境配置机制，通过application.properties、application-dev.properties和application-prod.properties三个文件实现不同环境的配置管理。主配置文件application.properties包含基础配置，开发环境和生产环境配置文件则提供特定环境的覆盖配置。

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-dev.properties](file://Boot/src/main/resources/application-dev.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)

## 数据库配置
数据库配置主要包含连接信息和连接池设置，通过Spring Boot的datasource配置项实现。

### 连接信息配置
```properties
spring.datasource.url=jdbc:mysql://47.92.127.30:3306/bot?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=UTC
spring.datasource.username=root
spring.datasource.password=gouzaizi@123
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
```

### 连接池配置
```properties
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.tomcat.initial-size=1
spring.datasource.tomcat.max-wait=20
spring.datasource.tomcat.min-idle=3
spring.datasource.tomcat.max-active=60000
spring.datasource.tomcat.time-between-eviction-runs-millis=60000
spring.datasource.tomcat.min-evictable-idle-time-millis=300000
spring.datasource.tomcat.validation-query==select 'x'
spring.datasource.tomcat.test-while-idle=true
spring.datasource.tomcat.test-on-borrow=false
spring.datasource.tomcat.test-on-return=false
```

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-dev.properties](file://Boot/src/main/resources/application-dev.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)

## 系统配置
系统配置包含机器人基础信息、消息发送配置和管理员密码等核心设置。

### 基础配置
```properties
server.port=9091
server.servlet.context-path=/bot
system.robot.qq=2732151511
system.message.send.key=murongyehua123
system.message.send.url=http://127.0.0.1:21213/SendTempIM.do
system.manager.password=0416
```

### 动态系统配置
系统还通过`bot_system_config`数据库表存储动态配置，由`SystemConfigHolder`类加载到`SystemConfigCache`缓存中。配置项包括：
- wid: 系统wid
- token: 认证token
- inviteCode: 邀请码
- topToken: 顶级token（逗号分隔的列表）
- signToken: 签到资格token（逗号分隔的列表）
- isMaintenance: 维护标记
- tuilanToken: 推栏token

```java
@Component
public class SystemConfigHolder {
    @PostConstruct
    public void init() {
        Map<String, String> configMap = systemConfigMapper.selectByExample(new SystemConfigExample())
                .stream().collect(Collectors.toMap(SystemConfig::getConfigType, SystemConfig::getConfigValue));
        SystemConfigCache.wId = configMap.get(ENSystemConfig.WID.getValue());
        SystemConfigCache.token = configMap.get(ENSystemConfig.TOKEN.getValue());
        SystemConfigCache.inviteCode = configMap.get(ENSystemConfig.INVITE_CODE.getValue());
        SystemConfigCache.topToken = Arrays.asList(configMap.get(ENSystemConfig.TOP_TOKEN.getValue()).split(","));
        SystemConfigCache.signToken = Arrays.asList(configMap.get(ENSystemConfig.SIGN_TOKEN.getValue()).split(","));
        SystemConfigCache.isMaintenance = configMap.get(ENSystemConfig.MAINTENANCE_FLAG.getValue());
        SystemConfigCache.tuilanToken = configMap.get(ENSystemConfig.TUILAN_TOKEN.getValue());
    }
}
```

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [SystemConfigHolder.java](file://Game/src/main/java/com/bot/game/service/SystemConfigHolder.java)
- [ENSystemConfig.java](file://Common/src/main/java/com/bot/common/enums/ENSystemConfig.java)
- [SystemConfig.java](file://Game/src/main/java/com/bot/game/dao/entity/SystemConfig.java)

## 外部API配置
项目集成了多个外部API服务，包括聊天、音乐、星座查询等。

### 聊天与娱乐服务
```properties
# 聊天服务
chat.url=http://113.45.63.97/v1/chat-messages
chat.key=sk-ymrdvcfjszkwtelpdclkixnyrouixanwyjrrvktsxazjhijw

# 情话服务
sweet.url=https://api.lovelive.tools/api/SweetNothings

# 音乐服务
cloud.music.url=https://api.uomg.com/api/rand.music

# 头像服务
picture.path=https://api.btstu.cn/sjtx/api.php

# 星座服务
constellation.path=http://web.juhe.cn:8080/constellation/getAll
constellation.key=4a11bbcbf089edaf14c2d9bdb80c2ec4
```

### 生产环境特有服务
```properties
# 图片生成服务
pic.create.url=https://api.siliconflow.cn/v1/images/generations

# 网格工具
grid.tool.url=https://cmms.hrtn.net:19002/grid/tool

# 女生视频
girl.url=https://tools.mgtv100.com/external/v1/pear/xjj

# 其他特色服务
dog.url=https://v2.xxapi.cn/api/dog
guard.url=https://api.linhun.vip/api/security?&apiKey=773b810df449be0ecffb56cf48c7e610
baisi.url=https://v2.xxapi.cn/api/baisi
heisi.url=https://v2.xxapi.cn/api/heisi
answer.book.url=https://v2.xxapi.cn/api/answers
```

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)

## 日志配置
日志系统采用Logback实现，通过logback-spring.xml进行详细配置。

### 配置文件结构
```xml
<configuration>
    <springProperty scope="context" name="logback.path" source="logback.rootPath"/>
    <springProperty scope="context" name="logback.rootPath" source="logback.rootPath"/>
    <springProperty scope="context" name="logback.pattern" source="logback.pattern"/>
    <springProperty scope="context" name="logback.charset" source="logback.charset"/>
    <springProperty scope="context" name="logback.level" source="logback.level"/>
    <springProperty scope="context" name="sql.level" source="logback.sql-level"/>

    <property name="logback.path" value="${logback.rootPath}/bot-controller" />
    <property name="project.name" value="bot" />

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>TRACE</level>
        </filter>
        <encoder charset="${logback.charset}">
            <pattern>${logback.pattern}</pattern>
        </encoder>
    </appender>

    <appender name="ROLLINGFILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>TRACE</level>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${logback.path}/%d{yyyy-MM-dd}/${project.name}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder charset="${logback.charset}">
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger-%line -- %msg --%n</pattern>
        </encoder>
    </appender>

    <appender name="ASYNC_ROLLING_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>2048</queueSize>
        <includeCallerData>false</includeCallerData>
        <appender-ref ref="ROLLINGFILE"/>
    </appender>

    <root level="${logback.level}">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_ROLLING_FILE"/>
    </root>
</configuration>
```

### 配置参数说明
| 参数 | 说明 |
|------|------|
| logback.level | 日志级别（INFO） |
| logback.rootPath | 日志根路径 |
| logback.charset | 字符编码（UTF-8） |
| logback.pattern | 日志输出格式 |
| logback.sql-level | SQL日志级别（DEBUG） |

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [logback-spring.xml](file://Boot/src/main/resources/logback-spring.xml)

## 环境配置差异对比
不同环境的配置文件在关键参数上存在明显差异，以适应不同部署环境的需求。

### 开发环境 vs 生产环境
| 配置项 | 开发环境 (dev) | 生产环境 (prod) | 说明 |
|--------|----------------|-----------------|------|
| logback.rootPath | D:\\home\\gardpay\\reconciliation\\logs\\ | /data/project/bot/logs | 日志存储路径 |
| system.message.send.url | http://10.60.45.114:21213/SendTempIM.do | http://127.0.0.1:21213/SendTempIM.do | 消息发送地址 |
| text.path | (空) | /data/project/bot/text/ | 文本文件路径 |
| chat.key | (未配置) | sk-ymrdvcfjszkwtelpdclkixnyrouixanwyjrrvktsxazjhijw | 聊天API密钥 |
| base.file.path | (未配置) | /data/files | 基础文件路径 |
| manager.token | (未配置) | wxid_gt9s4k14zz7l22 | 管理员token |

### spring.profiles.active作用机制
`spring.profiles.active`是Spring Boot的核心配置项，用于指定当前激活的配置文件。在application.properties中定义为：
```properties
spring.profiles.active=@profileActive@
```
该配置通过Maven资源过滤机制，在构建时根据指定的profile替换`@profileActive@`占位符。当设置为`dev`时，加载application-dev.properties中的配置；设置为`prod`时，加载application-prod.properties中的配置。这种机制实现了配置的环境隔离，确保不同环境使用相应的配置参数。

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-dev.properties](file://Boot/src/main/resources/application-dev.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)

## Druid连接池参数详解
Druid连接池通过一系列参数优化数据库连接性能和稳定性。

### 核心参数说明
| 参数 | 值 | 说明 | 性能影响 |
|------|----|------|---------|
| initial-size | 1 | 初始化连接数 | 过小可能导致启动时连接延迟，过大浪费资源 |
| max-active | 60000 | 最大活跃连接数 | 高并发场景下需足够大，但受数据库最大连接数限制 |
| min-idle | 3 | 最小空闲连接数 | 保持一定数量的空闲连接，减少新建连接开销 |
| max-wait | 20 | 获取连接最大等待时间（毫秒） | 过小可能导致连接获取失败，过大可能阻塞线程 |
| time-between-eviction-runs-millis | 60000 | 检测间隔时间（毫秒） | 定期清理无效连接，避免连接泄漏 |
| min-evictable-idle-time-millis | 300000 | 最小空闲时间（毫秒） | 防止连接过早被回收，平衡资源利用率 |
| validation-query | =select 'x' | 验证查询SQL | 用于检测连接有效性，应简单高效 |
| test-while-idle | true | 空闲时检测 | 提高连接可用性，但增加少量开销 |
| test-on-borrow | false | 获取时检测 | 减少获取连接开销，但可能获取到无效连接 |
| test-on-return | false | 归还时检测 | 减少归还连接开销，但可能归还无效连接 |

### 性能优化建议
1. **连接数配置**：根据应用并发量和数据库性能调整max-active和min-idle
2. **连接验证**：test-while-idle设置为true可提高连接质量，但会增加少量CPU开销
3. **超时设置**：合理设置max-wait避免线程长时间阻塞
4. **监控集成**：Druid提供详细的监控功能，可用于性能分析和故障排查

**Section sources**
- [application.properties](file://Boot/src/main/resources/application.properties)
- [application-dev.properties](file://Boot/src/main/resources/application-dev.properties)
- [application-prod.properties](file://Boot/src/main/resources/application-prod.properties)

## life_system_config表配置说明
Life模块的平衡性配置存储在`life_system_config`表中，通过配置项控制游戏核心机制。

### 配置项详细说明
| 配置键 | 默认值 | 说明 |
|--------|--------|------|
| speed_armor_break_rate | 0.005 | 每点速度增加的破防率 | 影响角色破防能力成长曲线 |
| constitution_health_rate | 10 | 每点体质增加的血量 | 决定角色生命值成长 |
| constitution_defense_rate | 1 | 每点体质增加的防御 | 影响角色防御力成长 |
| spirit_critical_rate | 0.01 | 每点灵力增加的会心率 | 控制暴击率成长速度 |
| spirit_critical_damage_rate | 0.005 | 每点灵力增加的会心效果 | 影响暴击伤害倍数 |
| strength_attack_rate | 6 | 每点力量增加的攻击力 | 决定物理攻击力成长 |
| strength_armor_break_rate | 0.01 | 每点力量增加的破防率 | 增强力量型角色的破防能力 |
| attribute_restraint_damage_bonus | 20 | 属性克制伤害加成百分比 | 增强属性相克的战斗策略性 |
| attribute_restrained_defense_penalty | 10 | 被属性克制防御减少百分比 | 强化属性相克的负面效果 |
| max_armor_break_rate | 30 | 最大破防率 | 限制破防效果的上限，防止过度破坏平衡 |

### 属性克制机制
游戏中的属性克制关系由ENAttribute枚举定义，包含金、木、水、火、土五种属性，克制关系如下：
- 金克木
- 木克土
- 土克水
- 水克火
- 火克金

当攻击方属性克制防御方时，伤害增加20%；当防御方属性被攻击方克制时，防御减少10%。这种双重加成机制强化了属性策略的重要性。

**Section sources**
- [Life_Deployment_Guide.md](file://Life_Deployment_Guide.md)

## 配置修改最佳实践与风险提示
### 最佳实践
1. **备份配置**：修改前备份原始配置文件和数据库配置
2. **逐步调整**：平衡性参数应小幅度调整，观察效果后再进行下一步
3. **环境隔离**：先在开发环境测试，再逐步推广到生产环境
4. **文档记录**：记录每次配置变更的原因、时间和负责人
5. **监控观察**：变更后密切监控系统性能和用户反馈

### 风险提示
1. **数据库连接风险**：错误的数据库配置可能导致服务无法启动
2. **性能影响**：不当的连接池配置可能耗尽数据库连接或导致内存溢出
3. **安全风险**：暴露敏感信息（如密码、token）可能导致安全漏洞
4. **平衡性破坏**：过度调整游戏参数可能破坏游戏经济系统和战斗平衡
5. **服务中断**：关键API配置错误可能导致功能不可用

### 配置变更流程
1. 分析需求，确定需要修改的配置项
2. 在开发环境进行变更和测试
3. 记录变更内容和预期效果
4. 在非高峰时段部署到生产环境
5. 监控系统状态和用户反馈
6. 准备回滚方案，以便快速恢复

**Section sources**
- [Life_Deployment_Guide.md](file://Life_Deployment_Guide.md)
- [application.properties](file://Boot/src/main/resources/application.properties)